apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: bitcoin-
spec:
  entrypoint: bitcoin
  templates:
  - name: bitcoin
    parallelism: 1
    steps:
    - - name: genrate-list            # 
        template: genrate-list

    - - name: bitcoin-loop          # 
        template: bitcoin-loop
        arguments:
          parameters:
          - name: urls
            value: "{{item}}"
        withParam: "{{steps.genrate-list.outputs.result}}"



  - name: bitcoin-loop
    inputs:
      parameters:
      - name: urls
    steps:
    - - name: get            # hello1 is run before the following steps
        template: bitcoin-get-comments-price
        arguments:
          parameters:
          - name: urls
            value: "{{inputs.parameters.urls}}"
    - - name: clean           # double dash => run after previous step
        template: clean
        arguments:
          parameters:
          - name: message
            value: "{{steps.get.outputs.parameters.path}}"



  - name: genrate-list
    script:
      image: gcr.io/kdcc-282418/python-worker
      command: [python]
      source: |
        import json
        import sys
        
        def generate_year_month():
          results = []
          for i in range(2013,2014): 
              for j in range(1,13):
                  if i == 2010 and j < 9:
                      pass
                  else:
                      results.append(str(i) + '-' + str(j).zfill(2))
          return ["https://files.pushshift.io/reddit/comments/RC_{}.bz2".format(x) for x in results]
        
        json.dump(generate_year_month(), sys.stdout)
      


  - name: bitcoin-get-comments-price
    inputs:
      parameters:
      - name: urls
    script:
      image: gcr.io/kdcc-282418/getter-worker
      # env:
      #   - name: AWS_SECRET_ACCESS_KEY
      #     valueFrom:
      #       secretKeyRef:
      #         name: aws-secret-config
      #         key: access_key
      #   - name: AWS_ACCESS_KEY_ID
      #     valueFrom:
      #       secretKeyRef:
      #         name: aws-secret-config
      #         key: key_id
      command: [python]
      source: |
        from wfunc import func
        import os
        
        bucket = 'workflowkddc' 
        prefix = 'Bitcoin/comments' 
        filetype = 'txt'
        url = "{{inputs.parameters.urls}}"
        # path = 'gs://workflowkddc/Bitcoin/RC_2011-01.txt'
        path = func.get_parse_json_to_gcs(url, bucket, prefix, filetype)

        if not os.path.exists('tmp'):
          os.makedirs('tmp')
        with open("/tmp/path.txt", 'w') as w:
          w.write(path)
        # print('func.get_parse_json_to_gcs')

    outputs:
      parameters:
      - name: path       # name of output parameter
        valueFrom:
          path: /tmp/path.txt
  
    
  - name: clean
    inputs:
      parameters:
      - name: message
    container:
      image: gcr.io/kdcc-282418/bitcoin-worker
      command: [python]
      args: ["wfunc/wfunc/bitcoin.py","{{inputs.parameters.message}}"]

        
        
# - https://files.pushshift.io/reddit/comments/RC_2010-09.bz2 # python wfunc/bitcoin.py 
# - https://files.pushshift.io/reddit/comments/RC_2010-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2010-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2010-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2011-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2012-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2013-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2014-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2015-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2016-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2017-12.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-01.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-02.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-03.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-04.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-05.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-06.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-07.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-08.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-09.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-10.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-11.bz2
# - https://files.pushshift.io/reddit/comments/RC_2018-12.bz2